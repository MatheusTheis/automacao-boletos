<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8"/>
<title>Registrar Boleto</title>
<style>
body{font-family:sans-serif;margin:2rem;max-width:500px}
label{display:block;margin-top:1rem}
input,select{width:100%;padding:.4rem}
button{margin-top:1.5rem;padding:.6rem 1rem;cursor:pointer}
body.dark-mode {
  background: #222;
  color: #eee;
}
body.dark-mode input, body.dark-mode select, body.dark-mode button {
  background: #333;
  color: #eee;
  border: 1px solid #555;
}
</style>
</head>
<body>
  <button id="btn-dark" style="margin-bottom:1rem;">Modo Escuro</button>
  <div style="margin-bottom:1rem;">
    <button onclick="escolherEmpresa('CEMAVI')">Cemavi</button>
    <button onclick="escolherEmpresa('MB')">MB</button>
  </div>
  <h2>Novo Boleto</h2>
  <form id="frm">
    <input type="hidden" name="empresa" value="CEMAVI">
    <label>Cliente <input name="cliente" required></label>
    <label>Nosso N¬∫ <input name="nosso" required></label>
    <label>Valor (ex.: 1234,56) <input name="valor" required></label>
    <label>Emiss√£o (DD/MM/AAAA) <input name="emiss" required></label>
    <label>Vencimento (DD/MM/AAAA) <input name="venc" required></label>
    <label><input type="checkbox" name="pago"> J√° est√° pago</label>
    <button type="submit">Registrar</button>
  </form>
  <p id="msg"></p>

<script>
/* 1. Carrega empresas e restaura a √∫ltima usada (localStorage) */
async function carregarEmpresas(){
  const empresas = await fetch('/api/empresas').then(r=>r.json());
  const sel = document.getElementById('empresa');

  empresas.forEach(e=>{
    const o = document.createElement('option');
    o.value = o.textContent = e;
    sel.appendChild(o);
  });

  const ultima = localStorage.getItem('ultimaEmpresaSelecionada');
  if (ultima && empresas.includes(ultima)) sel.value = ultima;
}

/* 2. Salva no localStorage sempre que trocar a empresa */
document.getElementById('empresa').addEventListener('change', ev=>{
  localStorage.setItem('ultimaEmpresaSelecionada', ev.target.value);
});

/* 3. Submiss√£o do formul√°rio */
document.getElementById('frm').addEventListener('submit', async ev=>{
  ev.preventDefault();
  const fd  = new FormData(ev.target);
  const obj = Object.fromEntries(fd.entries());
  obj.pago  = fd.has('pago');

  const sel  = document.getElementById('empresa');
  const idx  = sel.selectedIndex;
  const opt  = sel.options[idx];
  /* ---- Torna esta op√ß√£o o ‚Äúpadr√£o‚Äù do select ---- */
  [...sel.options].forEach(o=>o.defaultSelected = false); // zera anteriores
  opt.defaultSelected = true;                              // marca a atual

  localStorage.setItem('ultimaEmpresaSelecionada', opt.value); // persiste

  const rsp = await fetch('/api/boletos',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(obj)
  });

  const out = document.getElementById('msg');
  if (rsp.ok){
    const j = await rsp.json();
    out.textContent = `‚úî Gravado em ${j.arquivo} > ${j.aba}`;
    out.style.color = 'green';

    ev.target.reset();           // agora o reset preserva a empresa üëå
  }else{
    const j = await rsp.json();
    out.textContent = 'Erro: '+j.erro;
    out.style.color = 'red';
  }
});

carregarEmpresas();

// MODO ESCURO
document.getElementById('btn-dark').addEventListener('click', ()=>{
  document.body.classList.toggle('dark-mode');
  // Salva prefer√™ncia no localStorage
  localStorage.setItem('modoEscuro', document.body.classList.contains('dark-mode'));
});

// Aplica modo escuro se j√° estava ativado
if(localStorage.getItem('modoEscuro') === 'true'){
  document.body.classList.add('dark-mode');
}

// Redireciona para p√°gina da empresa escolhida
function escolherEmpresa(nome){
  window.location.href = `empresa.html?nome=${encodeURIComponent(nome)}`;
}

// Modo claro/escuro
  function atualizarBotaoModo() {
    const btn = document.getElementById('btn-dark');
    if (document.body.classList.contains('light')) {
      btn.textContent = 'Modo Escuro';
    } else {
      btn.textContent = 'Modo Claro';
    }
  }
  document.getElementById('btn-dark').addEventListener('click', ()=>{
    document.body.classList.toggle('light');
    localStorage.setItem('modoClaro', document.body.classList.contains('light'));
    atualizarBotaoModo();
  });
  if(localStorage.getItem('modoClaro') === 'true'){
    document.body.classList.add('light');
  }
  atualizarBotaoModo();

  // M√°scara de data
  function mascaraData(input) {
    input.addEventListener('input', function(e) {
      let v = input.value.replace(/\D/g, '').slice(0,8);
      if (v.length >= 5)
        input.value = v.replace(/(\d{2})(\d{2})(\d{0,4})/, '$1/$2/$3');
      else if (v.length >= 3)
        input.value = v.replace(/(\d{2})(\d{0,2})/, '$1/$2');
      else
        input.value = v;
    });
  }
  mascaraData(document.querySelector('input[name="emiss"]'));
  mascaraData(document.querySelector('input[name="venc"]'));

  // Submiss√£o do formul√°rio
  document.getElementById('frm').addEventListener('submit', async ev=>{
    ev.preventDefault();
    const fd  = new FormData(ev.target);
    const obj = Object.fromEntries(fd.entries());
    obj.pago  = fd.has('pago');
    const rsp = await fetch('/api/boletos',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(obj)
    });
    const out = document.getElementById('msg');
    if (rsp.ok){
      const j = await rsp.json();
      out.textContent = `‚úî Gravado em ${j.arquivo} > ${j.aba}`;
      out.style.color = 'green';
      ev.target.reset();
    }else{
      const j = await rsp.json();
      out.textContent = 'Erro: '+j.erro;
      out.style.color = 'red';
    }
  });

  // Bot√£o para MB
  document.querySelector('button[onclick*="empresa.html"]').addEventListener('click', function(){
    window.location.href = 'empresa.html';
  });
</script>
</body>
</html>
