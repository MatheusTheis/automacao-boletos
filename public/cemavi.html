<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <title>Registrar Boleto Cemavi</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="top-bar">
    <button id="btn-dark" class="btn">Modo Claro</button>
    <button onclick="window.location.href='mb.html'" class="btn">Ir para MB</button>
  </div>
  <div class="main-content">
    <h2>Novo Boleto Cemavi</h2>
    <form id="frm">
      <input type="hidden" name="empresa" value="CEMAVI">
      <label class="label">Cliente <input name="cliente" required class="input" list="clientes-cemavi" autocomplete="off"></label>
      <datalist id="clientes-cemavi"></datalist>
      <label class="label">Nosso Nº <input name="nosso" required class="input"></label>
      <label class="label">Valor <input name="valor" required class="input"></label>
      <label class="label">Emissão <input name="emiss" required class="input"></label>
      <label class="label">Vencimento <input name="venc" required class="input"></label>
      <button type="submit" class="btn primary">Registrar</button>
    </form>
    <p id="msg"></p>
  </div>
  <aside class="side-panel">
    <div class="card">
      <div class="card-title">Abertos</div>
      <div class="card-value">12</div>
      <div class="progress"><div class="progress-bar" style="width:60%"></div></div>
    </div>
    <div class="card">
      <div class="card-title">Pagos</div>
      <div class="card-value">8</div>
      <div class="progress"><div class="progress-bar" style="width:40%"></div></div>
    </div>
    <div class="card">
      <div class="card-title">Vencendo</div>
      <div class="card-value">3</div>
      <div class="progress"><div class="progress-bar" style="width:20%"></div></div>
    </div>
    <div class="card">
      <div class="card-title">Vencidos</div>
      <div class="card-value">1</div>
      <div class="progress"><div class="progress-bar" style="width:10%"></div></div>
    </div>
  </aside>
  <script>
    // Modo claro/escuro
    function atualizarBotaoModo() {
      const btn = document.getElementById('btn-dark');
      if (document.body.classList.contains('light')) {
        btn.textContent = 'Modo Escuro';
      } else {
        btn.textContent = 'Modo Claro';
      }
    }
    document.getElementById('btn-dark').addEventListener('click', ()=>{
      document.body.classList.toggle('light');
      localStorage.setItem('modoClaro', document.body.classList.contains('light'));
      atualizarBotaoModo();
    });
    if(localStorage.getItem('modoClaro') === 'true'){
      document.body.classList.add('light');
    }
    atualizarBotaoModo();

    // Máscara de data
    function mascaraData(input) {
      input.addEventListener('input', function(e) {
        let v = input.value.replace(/\D/g, '').slice(0,8);
        if (v.length >= 5)
          input.value = v.replace(/(\d{2})(\d{2})(\d{0,4})/, '$1/$2/$3');
        else if (v.length >= 3)
          input.value = v.replace(/(\d{2})(\d{0,2})/, '$1/$2');
        else
          input.value = v;
      });
    }
    mascaraData(document.querySelector('input[name="emiss"]'));
    mascaraData(document.querySelector('input[name="venc"]'));

    // Nosso Nº Cemavi: "000XXXXX-XX"
    const nossoInputCemavi = document.querySelector('input[name="nosso"]');
    if (nossoInputCemavi) {
      nossoInputCemavi.placeholder = "000_____-__";
      nossoInputCemavi.value = "000";

      nossoInputCemavi.addEventListener('input', function(e) {
        let v = nossoInputCemavi.value.replace(/^000/, '').replace(/\D/g, '');
        v = v.slice(0,7);
        let parte1 = v.slice(0,5);
        let parte2 = v.slice(5,7);
        let result = "000" + parte1;
        if (v.length > 5) result += "-" + parte2;
        nossoInputCemavi.value = result;
      });

      nossoInputCemavi.addEventListener('keydown', function(e) {
        const prefix = "000";
        // Impede apagar o prefixo
        if (
          nossoInputCemavi.selectionStart <= prefix.length &&
          (e.key === "Backspace" || e.key === "Delete")
        ) {
          e.preventDefault();
        }
        // Impede digitar o hífen manualmente
        if (e.key === "-") {
          e.preventDefault();
        }
      });

      nossoInputCemavi.addEventListener('blur', function() {
        if (!nossoInputCemavi.value.startsWith("000")) {
          nossoInputCemavi.value = "000";
        }
      });
    }

    // Navegação por Enter entre campos
    const campoCliente = document.querySelector('input[name="cliente"]');
    const campoNosso = document.querySelector('input[name="nosso"]');
    const campoValor = document.querySelector('input[name="valor"]');
    const campoEmiss = document.querySelector('input[name="emiss"]');
    const campoVenc = document.querySelector('input[name="venc"]');

    campoNosso.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        campoValor.focus();
      }
    });

    campoValor.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        campoEmiss.focus();
      }
    });

    campoEmiss.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        campoVenc.focus();
      }
    });

    // Carregar histórico de clientes do localStorage
    function carregarHistoricoClientes() {
      const historico = JSON.parse(localStorage.getItem('clientes-cemavi') || '[]');
      const datalist = document.getElementById('clientes-cemavi');
      datalist.innerHTML = '';
      historico.forEach(cliente => {
        const option = document.createElement('option');
        option.value = cliente;
        datalist.appendChild(option);
      });
    }

    // Obter o último cliente registrado
    function obterUltimoCliente() {
      const historico = JSON.parse(localStorage.getItem('clientes-cemavi') || '[]');
      return historico[0] || '';
    }

    // Salvar cliente no histórico
    function salvarClienteNoHistorico(nomeCliente) {
      let historico = JSON.parse(localStorage.getItem('clientes-cemavi') || '[]');
      // Remove duplicatas e adiciona o novo no início
      historico = historico.filter(c => c !== nomeCliente);
      historico.unshift(nomeCliente);
      // Mantém apenas os últimos 3 clientes
      historico = historico.slice(0, 3);
      localStorage.setItem('clientes-cemavi', JSON.stringify(historico));
      carregarHistoricoClientes();
    }

    // Carregar histórico ao iniciar
    carregarHistoricoClientes();

    // Atalho Ctrl + Space para autocompletar com o último cliente
    campoCliente.addEventListener('keydown', function(e) {
      // Ctrl + Space
      if (e.ctrlKey && (e.code === 'Space' || e.keyCode === 32)) {
        e.preventDefault();
        e.stopPropagation();
        const ultimoCliente = obterUltimoCliente();
        console.log('Ctrl+Space pressionado. Último cliente:', ultimoCliente);
        if (ultimoCliente) {
          this.value = ultimoCliente;
          console.log('Campo preenchido com:', ultimoCliente);
        } else {
          console.log('Nenhum cliente no histórico');
        }
        return false;
      }
      // Enter para ir ao próximo campo
      if (e.key === 'Enter') {
        e.preventDefault();
        campoNosso.focus();
      }
    });

    // Mostrar sugestões quando digitar qualquer letra
    campoCliente.addEventListener('input', function() {
      if (this.value.length > 0) {
        // Força mostrar todas as sugestões quando há qualquer texto
        const historico = JSON.parse(localStorage.getItem('clientes-cemavi') || '[]');
        const datalist = document.getElementById('clientes-cemavi');
        datalist.innerHTML = '';
        historico.forEach(cliente => {
          const option = document.createElement('option');
          option.value = cliente;
          datalist.appendChild(option);
        });
      }
    });

    // Submissão do formulário
    document.getElementById('frm').addEventListener('submit', async ev=>{
      ev.preventDefault();
      const fd  = new FormData(ev.target);
      const obj = Object.fromEntries(fd.entries());
      const rsp = await fetch('/api/boletos',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(obj)
      });
      const out = document.getElementById('msg');
      if (rsp.ok){
        const j = await rsp.json();
        out.textContent = `✔ Gravado em ${j.arquivo} > ${j.aba}`;
        out.style.color = 'green';
        // Salvar cliente no histórico
        salvarClienteNoHistorico(obj.cliente);
        console.log('Cliente salvo no histórico:', obj.cliente);
        console.log('Histórico atual:', JSON.parse(localStorage.getItem('clientes-cemavi') || '[]'));
        ev.target.reset();
        // Restaurar o valor padrão do campo Nosso Nº
        if (nossoInputCemavi) {
          nossoInputCemavi.value = "000";
        }
        // Focar no campo cliente para o próximo boleto
        campoCliente.focus();
      }else{
        const j = await rsp.json();
        out.textContent = 'Erro: '+j.erro;
        out.style.color = 'red';
      }
    });
  </script>
</body>
</html>
