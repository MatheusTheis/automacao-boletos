<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8"/>
  <title>Registrar Boleto MB</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="top-bar">
    <button id="btn-dark" class="btn">Modo Claro</button>
    <button onclick="window.location.href='index.html'" class="btn">Voltar</button>
  </div>
  <div class="main-content">
    <h2>Novo Boleto MB</h2>
    <form id="frm">
      <input type="hidden" name="empresa" value="MB">
      <label class="label">Cliente <input name="cliente" required class="input"></label>
      <label class="label">Nosso Nº <input name="nosso" required class="input"></label>
      <label class="label">Valor <input name="valor" required class="input"></label>
      <label class="label">Emissão <input name="emiss" required class="input"></label>
      <label class="label">Vencimento <input name="venc" required class="input"></label>
      <div class="checkbox-group">
        <input type="checkbox" name="pago" class="input-checkbox" id="pago">
        <label for="pago" class="checkbox-label">Já está pago</label>
      </div>
      <button type="submit" class="btn primary">Registrar</button>
    </form>
    <p id="msg"></p>
  </div>
  <aside class="side-panel">
    <div class="card">
      <div class="card-title">Abertos</div>
      <div class="card-value">5</div>
      <div class="progress"><div class="progress-bar" style="width:50%"></div></div>
    </div>
    <div class="card">
      <div class="card-title">Pagos</div>
      <div class="card-value">2</div>
      <div class="progress"><div class="progress-bar" style="width:20%"></div></div>
    </div>
    <div class="card">
      <div class="card-title">Vencendo</div>
      <div class="card-value">2</div>
      <div class="progress"><div class="progress-bar" style="width:20%"></div></div>
    </div>
    <div class="card">
      <div class="card-title">Vencidos</div>
      <div class="card-value">1</div>
      <div class="progress"><div class="progress-bar" style="width:10%"></div></div>
    </div>
  </aside>
  <script>
    // Modo claro/escuro
    function atualizarBotaoModo() {
      const btn = document.getElementById('btn-dark');
      if (document.body.classList.contains('light')) {
        btn.textContent = 'Modo Escuro';
      } else {
        btn.textContent = 'Modo Claro';
      }
    }
    document.getElementById('btn-dark').addEventListener('click', ()=>{
      document.body.classList.toggle('light');
      localStorage.setItem('modoClaro', document.body.classList.contains('light'));
      atualizarBotaoModo();
    });
    if(localStorage.getItem('modoClaro') === 'true'){
      document.body.classList.add('light');
    }
    atualizarBotaoModo();

    // Máscara de data
    function mascaraData(input) {
      input.addEventListener('input', function(e) {
        let v = input.value.replace(/\D/g, '').slice(0,8);
        if (v.length >= 5)
          input.value = v.replace(/(\d{2})(\d{2})(\d{0,4})/, '$1/$2/$3');
        else if (v.length >= 3)
          input.value = v.replace(/(\d{2})(\d{0,2})/, '$1/$2');
        else
          input.value = v;
      });
    }
    mascaraData(document.querySelector('input[name="emiss"]'));
    mascaraData(document.querySelector('input[name="venc"]'));

    // Nosso Nº MB: "0000XXXX-XX"
    const nossoInputMB = document.querySelector('input[name="nosso"]');
    if (nossoInputMB) {
      nossoInputMB.placeholder = "0000____-__";
      nossoInputMB.value = "0000";

      nossoInputMB.addEventListener('input', function(e) {
        let v = nossoInputMB.value.replace(/^0000/, '').replace(/\D/g, '');
        v = v.slice(0,6);
        let parte1 = v.slice(0,4);
        let parte2 = v.slice(4,6);
        let result = "0000" + parte1;
        if (v.length > 4) result += "-" + parte2;
        nossoInputMB.value = result;
      });

      nossoInputMB.addEventListener('keydown', function(e) {
        const prefix = "0000";
        // Impede apagar o prefixo
        if (
          nossoInputMB.selectionStart <= prefix.length &&
          (e.key === "Backspace" || e.key === "Delete")
        ) {
          e.preventDefault();
        }
        // Impede digitar o hífen manualmente
        if (e.key === "-") {
          e.preventDefault();
        }
      });

      nossoInputMB.addEventListener('blur', function() {
        if (!nossoInputMB.value.startsWith("0000")) {
          nossoInputMB.value = "0000";
        }
      });
    }

    // Submissão do formulário
    document.getElementById('frm').addEventListener('submit', async ev=>{
      ev.preventDefault();
      const fd  = new FormData(ev.target);
      const obj = Object.fromEntries(fd.entries());
      obj.pago  = fd.has('pago');
      const rsp = await fetch('/api/boletos',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify(obj)
      });
      const out = document.getElementById('msg');
      if (rsp.ok){
        const j = await rsp.json();
        out.textContent = `✔ Gravado em ${j.arquivo} > ${j.aba}`;
        out.style.color = 'green';
        ev.target.reset();
      }else{
        const j = await rsp.json();
        out.textContent = 'Erro: '+j.erro;
        out.style.color = 'red';
      }
    });
  </script>
</body>
</html>